{% extends 'manager/include/include.html' %}

{% block content %}
<div class="container-fluid">

    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">측정 데이터 관리</h1>
    <p class="mb-4">고객의 측정 데이터를 관리합니다.</p>
    <!-- 고객 정보 -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">측정 목록</h6>
        </div>
        <div class="card-body">
            <div class="alert alert-primary">
                <div>※ 하지근기능(등급)과 심폐기능(등급)은 자동으로 산출됩니다.</div>
                <div>※ 이름, 회원번호, 생년월일, 성별, 신장, 체중, 평가일을 선기입하고, 30초 의자(회), 2분제자리걷기(회)를 기입하면 등급이 자동으로 산출됩니다.</div>
                <div>※ 첫 행의 예시 입력을 참고해 주세요. (생년월일은 yyyymmdd로 입력합니다.)</div>
                <div>※ 등급 산출은 성별, 연령, 횟수를 기반으로 산출됩니다.</div>
            </div>
            <div class="pull-right mb-3" style="display : flex; align-items : center;">
                <input id="export" type="button" class="btn btn-success btn-sm mr-1" value="데이터 추출" />
                <input id="save" type="button" class="btn btn-primary btn-sm mr-1" value="내용 저장" />
                <span id="need_to_save"></span>
            </div>
            <div class="pull-right mb-3" style="display : flex; align-items : center;">
                <input id="report" type="button" class="btn btn-primary btn-sm mr-1" value="보고서 생성" />
                <span id="report-name"></span>
            </div>
            <div id="data-sheet">
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block js %}
<script>
    const save = document.querySelector('#save');
    const exportBtn = document.querySelector('#export');
    const message = document.querySelector('#need_to_save');
    const container = document.querySelector('#data-sheet');
    const reportBtn = document.querySelector('#report');
    const reportText = document.querySelector('#report-name'); // Notify selectet user
     
    let selectedRow, selectedName;
    let isChange = false;

    const chairValueIndex = 7;
    const walkValueIndex = 9;

    const chairGrade = 0;

    const headers = ['이름', '회원번호', '생년월일', '성별', '신장', '체중', '평가일', '30초 의자(회)', '하지근기능(등급)', '2분제자리걷기(회)', '심폐기능(등급)','비고'];
  
    const hot = new Handsontable(container, {
        data: [], 
        // 너비 설정
        width: '100%',
        // stretchH: 'all',
        height : 500,
        // 열 별로 너비를 지정할 수도 있음
        // colWidths: [100, 100, 100, 100, 100, 100 ],
        // 로우 인덱스 값을 사용할지 여부
        rowHeaders: true,
        // 컬럼 헤더 값, 값을 true로 설정할 경우 A, B, C, D... 순으로 헤더가 생성됨
        colHeaders: headers, 
        // 최소 여유분의 행 설정
        minSpareRows: 1, 
        // 값이 없을 경우 기본적으로 생성되는 그리드의 사이즈 지정
        startRows : 20,
        // startCols : 100,
        // locally 하게 저장할 경우 사용할 수 있음
        customBorders: true,
        dropdownMenu: true,
        multiColumnSorting: true,
        filters: true,
        // manualRowMove: true,
        dateFormat: 'YYYY-MM-DD',
        columns : [
            {},
            {},
            {},
            {
                type : 'select',
                selectOptions: ['남', '여']
            },
            {},
            {},
            {
                type : 'date',
                dateFormat : 'YYYY-MM-DD',
                correctFormat : true,
            },
            {},
            {},
            {},
            {},
            {}
        ],
        licenseKey: 'non-commercial-and-evaluation' // for non-commercial use only
    });

    $(document).ready(function () {
        $.ajax({
            url: '/manage/measurement/load',
            type: 'GET',
            success: function (data) {
                if (data.data.length > 0){
                    hot.loadData(data.data);
                }
            }
        });
    });

    hot.addHook("afterSelection", async (row, col, row2, col2, preventScrolling, selectionLayerLevel) => {
        const name = hot.getDataAtCell(row, 0);
        let message = "";
        if (name === null){
            message = "사용자 이름의 행을 클릭해 주세요."
        }else{
            selectedRow = row
            selectedName = name;
            message = "클릭 시! " + name + "님의 보고서를 생성합니다.";
        }
        reportText.innerHTML = message;
    });

    reportBtn.addEventListener('click', () => {
        // get '이름' from row
        console.log(selectedRow, selectedName);
        if (selectedName === undefined || selectedName === undefined){
            alert("보고서 생성하려고 하는 인원의 행을 한번 클릭한 이후 다시 클릭해 주세요.");
        }else{
            requestUserReport(selectedRow, selectedName);
        }
    });

    function requestUserReport(row, name){
        $.ajax({
            url: '/manage/measurement/report',
            type: 'POST',
            data: {
                name : name,
                row : row
            },
            success: function (data) {
                console.log(data);
                if (data.success){
                    // download file from link
                    const downloadLink = data.data.link;
                    const link = document.createElement('a');
                    link.href = downloadLink;
                    link.download = 'report.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert("보고서 생성에 실패하였습니다.");
                }
            }
        }); 
    }

    hot.addHook("afterChange", async (change, source) => {
        if (source === 'loadData') {
            return; //don't save this change
        }
        
        const [row, prop, oldValue, newValue] = change[0];
        
        if (oldValue != newValue) {
            changeIsChangeStatus(true); 
        }
        
        updateGradeByValue(row, prop, newValue);

        console.log(row, prop, oldValue, newValue);

    });

    function getAgeFromBirth(birth) {
        const year = parseInt(birth.substring(0, 4));
        const month = parseInt(birth.substring(4, 6)) - 1; // JavaScript months are 0-indexed
        const day = parseInt(birth.substring(6, 8));
    
        const birthDate = new Date(year, month, day);
        const today = new Date();
    
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
    
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
    
        return age;
    }

    function appendGradeLabel(grade){
        let label = "";
        if (grade == 1){
            label = "등급 (매우 좋음)";
        }else if (grade == 2){
            label = "등급 (좋음)";
        }else if (grade == 3){
            label = "등급 (보통)";
        }else if (grade == 4){
            label = "등급 (미달)";
        }
        return grade + label;
    }

    function getGradeBytype(value, type, gender, age){
        const iAge = getAgeFromBirth(age);
        console.log("[getGradeBytype]" + type, gender, iAge, value);

        if (type == "chair"){
            if (iAge >= 85){
                if (gender == "남"){
                    if (value >= 16){
                        return 1;
                    } else if (value >= 13){
                        return 2;
                    } else if (value >= 10){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 14){
                        return 1;
                    } else if (value >= 11){
                        return 2;
                    } else if (value >= 9){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else if (iAge >= 80){
                if (gender == "남"){
                    if (value >= 18){
                        return 1;
                    } else if (value >= 15){
                        return 2;
                    } else if (value >= 11){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 15){
                        return 1;
                    } else if (value >= 13){
                        return 2;
                    } else if (value >= 10){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else if (iAge >= 75){
                if (gender == "남"){
                    if (value >= 20){
                        return 1;
                    } else if (value >= 17){
                        return 2;
                    } else if (value >= 14){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 18){
                        return 1;
                    } else if (value >= 15){
                        return 2;
                    } else if (value >= 12){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else if (iAge >= 70){
                if (gender == "남"){
                    if (value >= 22){
                        return 1;
                    } else if (value >= 19){
                        return 2;
                    } else if (value >= 15){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 20){
                        return 1;
                    } else if (value >= 17){
                        return 2;
                    } else if (value >= 14){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else if (iAge >= 65){
                if (gender == "남"){
                    if (value >= 25){
                        return 1;
                    } else if (value >= 21){
                        return 2;
                    } else if (value >= 17){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 22){
                        return 1;
                    } else if (value >= 19){
                        return 2;
                    } else if (value >= 16){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else {
                return 1;
            }
        } else if (type == "walk"){
            if (iAge >= 85){
                if (gender == "남"){
                    if (value >= 94){
                        return 1;
                    } else if (value >= 77){
                        return 2;
                    } else if (value >= 59){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 76){
                        return 1;
                    } else if (value >= 58){
                        return 2;
                    } else if (value >= 41){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else if (iAge >= 80){
                if (gender == "남"){
                    if (value >= 105){
                        return 1;
                    } else if (value >= 89){
                        return 2;
                    } else if (value >= 73){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 93){
                        return 1;
                    } else if (value >= 75){
                        return 2;
                    } else if (value >= 57){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else if (iAge >= 75){
                if (gender == "남"){
                    if (value >= 112){
                        return 1;
                    } else if (value >= 97){
                        return 2;
                    } else if (value >= 83){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 103){
                        return 1;
                    } else if (value >= 87){
                        return 2;
                    } else if (value >= 71){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else if (iAge >= 70){
                if (gender == "남"){
                    if (value >= 116){
                        return 1;
                    } else if (value >= 103){
                        return 2;
                    } else if (value >= 90){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 111){
                        return 1;
                    } else if (value >= 97){
                        return 2;
                    } else if (value >= 82){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else if (iAge >= 65){
                if (gender == "남"){
                    if (value >= 122){
                        return 1;
                    } else if (value >= 109){
                        return 2;
                    } else if (value >= 97){
                        return 3;
                    } else {
                        return 4;
                    }
                } else {
                    if (value >= 117){
                        return 1;
                    } else if (value >= 104){
                        return 2;
                    } else if (value >= 90){
                        return 3;
                    } else {
                        return 4;
                    }
                }
            }else {
                return 1;
            }
        }
    }
    function updateGradeByValue(i, j, value){
        // insert grade value by value with (i, j)
        let type = "";
        const gender = hot.getDataAtCell(i, 3);
        const age = hot.getDataAtCell(i, 2);
        
        if (!(j == chairValueIndex || j == walkValueIndex)){
            console.log(j + "is not supported!");
            return;
        }

        if (j == chairValueIndex){
            type = "chair";
        } else if (j == walkValueIndex){
            type = "walk";
        }
        
        let grade = getGradeBytype(value, type, gender, age);
        grade = appendGradeLabel(grade);
        

        hot.setDataAtCell(i, j + 1, grade);
    }

    exportBtn.addEventListener('click', () => {
        const exportPlugin = hot.getPlugin('exportFile');
        exportPlugin.downloadFile('csv', {
            bom: false,
            columnDelimiter: ',',
            columnHeaders: false,
            exportHiddenColumns: true,
            exportHiddenRows: true,
            fileExtension: 'csv',
            filename: 'daekyo_dataset_[YYYY]-[MM]-[DD]',
            mimeType: 'text/csv',
            rowDelimiter: '\r\n',
            rowHeaders: true
          });
    });

    save.addEventListener('click', async () => {
        // save all cell's data
        try{
            const res = await fetch('/manage/measurement/save', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: hot.getData() })
            });
            const data = await res.json();
            
            if (!data.success) {
                throw new Error(data.message);
            }
            changeIsChangeStatus(false);
        } catch (error){
            alert("저장에 실패하였습니다." + error);
        }
      });

    
      function changeIsChangeStatus(bool){
        isChange = bool;

        if (isChange){
            message.innerHTML = "변경된 내용이 있습니다. 저장 버튼을 눌러주세요.";
            message.style.color = "red";
        } else {
            message.innerHTML = "성공적으로 저장되었습니다.";
            message.style.color = "green";
        }
    }


</script>
{% endblock js %}
